<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CFO Rule Settings</title>

<style>
body{
    font-family: Arial, sans-serif;
    background:#eef2f7;
    padding:40px;
}

.container{
    background:white;
    max-width:800px;
    margin:auto;
    padding:30px;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
}

h2{
    text-align:center;
    color:#2c3e50;
}

label{
    font-weight:bold;
    display:block;
    margin-top:15px;
}

input, select{
    width:100%;
    padding:10px;
    margin-top:5px;
    border-radius:6px;
    border:1px solid #ccc;
}

.currency-box{
    display:flex;
    align-items:center;
}

.currency-box span{
    margin-left:10px;
    font-weight:bold;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}

th, td{
    border:1px solid #ddd;
    padding:8px;
    text-align:center;
}

th{
    background:#4a90e2;
    color:white;
}

button{
    margin-top:15px;
    padding:8px 12px;
    background:#4a90e2;
    color:white;
    border:none;
    border-radius:4px;
    cursor:pointer;
}

button:hover{
    background:#357abd;
}

.arrow-btn{
    padding:4px 8px;
    margin:2px;
}
</style>
</head>

<body>

<div class="container">

<h2>CFO Rule Settings</h2>

<label>User Name</label>
<select id="user" onchange="autoFillManager()"></select>

<label>Manager</label>
<input type="text" id="manager" readonly>

<label>Manager Approval Limit</label>
<div class="currency-box">
    <input type="number" id="limit" placeholder="Enter max approval amount">
    <span id="currency"></span>
</div>

<h3 style="margin-top:25px;">Approvers</h3>

<table id="approverTable">
<thead>
<tr>
    <th>Sr.No.</th>
    <th>User</th>
    <th>Required</th>
    <th>Position</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button onclick="addApprover()">+ Add User</button>
<button onclick="goBack()">Back</button>

</div>

<script>

let usersData = [];

// Load users & currency
window.onload = function(){

    usersData = JSON.parse(localStorage.getItem("users")) || [];

    const userDropdown = document.getElementById("user");

    userDropdown.innerHTML = "";

    usersData.forEach(user => {
        let option = document.createElement("option");
        option.value = user.name;
        option.text = user.name;
        userDropdown.add(option);
    });

    loadCurrency();
};


// Auto fill manager
function autoFillManager(){

    const selectedUser = document.getElementById("user").value;
    const userObj = usersData.find(u => u.name === selectedUser);

    if(userObj){
        if(userObj.role === "manager"){
            document.getElementById("manager").value = "-";
        } else {
            document.getElementById("manager").value = userObj.manager || "-";
        }
    }
}


// Load currency from signup
function loadCurrency(){

    const cfo = JSON.parse(localStorage.getItem("cfoAccount"));

    if(!cfo) return;

    fetch(`https://restcountries.com/v3.1/name/${cfo.country}`)
    .then(res => res.json())
    .then(data => {
        const currencyObj = data[0].currencies;
        const code = Object.keys(currencyObj)[0];
        document.getElementById("currency").innerText = code;
    })
    .catch(() => {
        document.getElementById("currency").innerText = "";
    });
}


// Add approver row
function addApprover(){

    const table = document
        .getElementById("approverTable")
        .getElementsByTagName("tbody")[0];

    const row = table.insertRow();

    const srCell = row.insertCell(0);
    const userCell = row.insertCell(1);
    const reqCell = row.insertCell(2);
    const posCell = row.insertCell(3);

    srCell.innerText = table.rows.length;

    // User dropdown
    let select = document.createElement("select");

    usersData.forEach(user => {
        let option = document.createElement("option");
        option.value = user.name;
        option.text = user.name;
        select.add(option);
    });

    userCell.appendChild(select);

    // Required checkbox
    let checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    reqCell.appendChild(checkbox);

    // Position arrows
    posCell.innerHTML = `
        <button class="arrow-btn" onclick="moveUp(this)">⬆</button>
        <button class="arrow-btn" onclick="moveDown(this)">⬇</button>
    `;
}


// Move Up
function moveUp(btn){
    const row = btn.closest("tr");
    const prev = row.previousElementSibling;
    if(prev){
        row.parentNode.insertBefore(row, prev);
        updateSerial();
    }
}

// Move Down
function moveDown(btn){
    const row = btn.closest("tr");
    const next = row.nextElementSibling;
    if(next){
        row.parentNode.insertBefore(next, row);
        updateSerial();
    }
}

// Update Serial Numbers
function updateSerial(){
    const rows = document.querySelectorAll("#approverTable tbody tr");
    rows.forEach((row, index) => {
        row.cells[0].innerText = index + 1;
    });
}

function goBack(){
    window.location.href = "account_creation.html";
}

</script>

</body>
</html>


