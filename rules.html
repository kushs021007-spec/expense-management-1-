<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CFO Rule Settings</title>

<style>
body{
    font-family: Arial, sans-serif;
    background:#eef2f7;
    padding:40px;
}

.container{
    background:white;
    max-width:600px;
    margin:auto;
    padding:30px;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
}

h2{
    text-align:center;
    color:#2c3e50;
}

label{
    font-weight:bold;
    display:block;
    margin-top:15px;
}

input, select{
    width:100%;
    padding:10px;
    margin-top:5px;
    border-radius:6px;
    border:1px solid #ccc;
}

button{
    margin-top:20px;
    width:100%;
    padding:12px;
    background:#4a90e2;
    color:white;
    border:none;
    border-radius:6px;
    cursor:pointer;
}

button:hover{
    background:#357abd;
}
</style>
</head>

<body>

<div class="container">
<h2>CFO Rule Settings</h2>

<label>User Name</label>
<select id="user" onchange="autoFillManager()"></select>

<label>Manager Name</label>
<select id="manager"></select>

<label>Manager Approval Limit (₹)</label>
<input type="number" id="limit"
placeholder="Enter max approval amount">

<label>Mandatory Middleman Approvers (comma separated)</label>
<input type="text" id="middleman"
placeholder="Example: FinanceHead, Auditor">

<button onclick="saveRules()">Save Rules</button>
<button onclick="goBack()">Back</button>

</div>

<script>

let usersData = [];

// Load users from localStorage
window.onload = function(){

    usersData = JSON.parse(localStorage.getItem("users")) || [];

    const userDropdown = document.getElementById("user");
    const managerDropdown = document.getElementById("manager");

    userDropdown.innerHTML = "";
    managerDropdown.innerHTML = "";

    // Fill user dropdown (all users)
    usersData.forEach(user => {
        let option = document.createElement("option");
        option.value = user.name;
        option.text = user.name;
        userDropdown.add(option);
    });

    // Fill manager dropdown (only managers)
    usersData
        .filter(user => user.role === "manager")
        .forEach(manager => {
            let option = document.createElement("option");
            option.value = manager.name;
            option.text = manager.name;
            managerDropdown.add(option);
        });
};


// Auto-fill manager when user selected
function autoFillManager(){

    const selectedUser =
        document.getElementById("user").value;

    const managerDropdown =
        document.getElementById("manager");

    const userObj =
        usersData.find(u => u.name === selectedUser);

    if(userObj){

        if(userObj.role === "manager"){

            managerDropdown.innerHTML = "<option>-</option>";
            managerDropdown.disabled = true;

        } else {

            managerDropdown.disabled = false;
            managerDropdown.innerHTML = "";

            // refill managers
            usersData
                .filter(u => u.role === "manager")
                .forEach(manager => {
                    let option = document.createElement("option");
                    option.value = manager.name;
                    option.text = manager.name;
                    managerDropdown.add(option);
                });

            managerDropdown.value = userObj.manager;
        }
    }
}


// Save Rules Logic
function saveRules(){

    const user = document.getElementById("user").value;
    const manager = document.getElementById("manager").value;
    const limit = document.getElementById("limit").value;

    const middlemen =
        document.getElementById("middleman").value
        .split(",")
        .map(name => name.trim())
        .filter(name => name !== "");

    let requiredApproval = 1;

    if(middlemen.length > 1){
        requiredApproval = Math.ceil(middlemen.length * 0.66);
    }

    alert(
`Rules Saved ✅

User: ${user}
Manager: ${manager}
Max Approval: ₹${limit}

Middlemen: ${middlemen.join(", ") || "None"}
Required Approvals: ${requiredApproval}`
    );
}


// Back to Account Page
function goBack(){
    window.location.href = "account_creation.html";
}

</script>

</body>
</html>
