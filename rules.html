<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CFO Rule Settings</title>

<style>
body{
    font-family: Arial, sans-serif;
    background:#eef2f7;
    padding:40px;
}

.container{
    background:white;
    max-width:850px;
    margin:auto;
    padding:30px;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
}

h2{
    text-align:center;
    color:#2c3e50;
}

label{
    font-weight:bold;
    display:block;
    margin-top:15px;
}

input, select{
    width:100%;
    padding:10px;
    margin-top:5px;
    border-radius:6px;
    border:1px solid #ccc;
}

.currency-box{
    display:flex;
    align-items:center;
}

.currency-box span{
    margin-left:10px;
    font-weight:bold;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}

th, td{
    border:1px solid #ddd;
    padding:8px;
    text-align:center;
}

th{
    background:#4a90e2;
    color:white;
}

button{
    margin-top:15px;
    padding:8px 12px;
    background:#4a90e2;
    color:white;
    border:none;
    border-radius:4px;
    cursor:pointer;
}

button:hover{
    background:#357abd;
}

.arrow-btn{
    padding:4px 8px;
    margin:2px;
}
</style>
</head>

<body>

<div class="container">

<h2>CFO Rule Settings</h2>

<label>User Name</label>
<select id="user" onchange="autoFillManager()"></select>

<label>Manager</label>
<input type="text" id="manager" readonly>

<label>Manager Approval Limit</label>
<div class="currency-box">
    <input type="number" id="limit" placeholder="Enter max approval amount">
    <span id="currency"></span>
</div>

<h3 style="margin-top:25px;">Approvers</h3>

<table id="approverTable">
<thead>
<tr>
    <th>Sr.No.</th>
    <th>User</th>
    <th>Required</th>
    <th>Position</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button onclick="addApprover()">+ Add User</button>
<button onclick="saveRules()">Save Rules</button>
<button onclick="goBack()">Back</button>

</div>

<script>

let usersData = [];
let allRules = {};

// On Load
window.onload = function(){

    usersData = JSON.parse(localStorage.getItem("users")) || [];
    allRules = JSON.parse(localStorage.getItem("rulesData")) || {};

    const userDropdown = document.getElementById("user");
    userDropdown.innerHTML = "";

    usersData.forEach(user => {
        let option = document.createElement("option");
        option.value = user.name;
        option.text = user.name;
        userDropdown.add(option);
    });

    loadCurrency();
};


// Auto fill manager & load saved rules
function autoFillManager(){

    const selectedUser = document.getElementById("user").value;
    const userObj = usersData.find(u => u.name === selectedUser);

    if(userObj){
        if(userObj.role === "manager"){
            document.getElementById("manager").value = "-";
        } else {
            document.getElementById("manager").value =
                userObj.manager || "-";
        }
    }

    loadSavedRules(selectedUser);
}


// Load Currency from Signup Page
function loadCurrency(){

    const cfo = JSON.parse(localStorage.getItem("cfoAccount"));
    if(!cfo) return;

    fetch(`https://restcountries.com/v3.1/name/${cfo.country}`)
    .then(res => res.json())
    .then(data => {
        const currencyObj = data[0].currencies;
        const code = Object.keys(currencyObj)[0];
        document.getElementById("currency").innerText = code;
    })
    .catch(() => {
        document.getElementById("currency").innerText = "";
    });
}


// Save Rules User-wise
function saveRules(){

    const user = document.getElementById("user").value;
    const limit = document.getElementById("limit").value;

    const rows =
        document.querySelectorAll("#approverTable tbody tr");

    let approvers = [];

    rows.forEach(row => {

        const name =
            row.cells[1].querySelector("select").value;

        const required =
            row.cells[2].querySelector("input").checked;

        approvers.push({name, required});
    });

    allRules[user] = {
        limit,
        approvers
    };

    localStorage.setItem("rulesData",
        JSON.stringify(allRules));

    alert("Rules Saved Successfully ✅");
}


// Load Saved Rules
function loadSavedRules(user){

    document.getElementById("limit").value = "";

    const tbody =
        document.querySelector("#approverTable tbody");

    tbody.innerHTML = "";

    if(!allRules[user]) return;

    document.getElementById("limit").value =
        allRules[user].limit;

    allRules[user].approvers.forEach((app, index) => {

        const row = tbody.insertRow();

        row.insertCell(0).innerText = index + 1;

        const userCell = row.insertCell(1);
        const reqCell = row.insertCell(2);
        const posCell = row.insertCell(3);

        let select = document.createElement("select");

        usersData.forEach(u => {
            let option = document.createElement("option");
            option.value = u.name;
            option.text = u.name;
            if(u.name === app.name) option.selected = true;
            select.add(option);
        });

        userCell.appendChild(select);

        let checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = app.required;
        reqCell.appendChild(checkbox);

        posCell.innerHTML = `
            <button class="arrow-btn" onclick="moveUp(this)">⬆</button>
            <button class="arrow-btn" onclick="moveDown(this)">⬇</button>
        `;
    });
}


// Add Approver Row
function addApprover(){

    const tbody =
        document.querySelector("#approverTable tbody");

    const row = tbody.insertRow();

    row.insertCell(0).innerText = tbody.rows.length;

    const userCell = row.insertCell(1);
    const reqCell = row.insertCell(2);
    const posCell = row.insertCell(3);

    let select = document.createElement("select");

    usersData.forEach(user => {
        let option = document.createElement("option");
        option.value = user.name;
        option.text = user.name;
        select.add(option);
    });

    userCell.appendChild(select);

    let checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    reqCell.appendChild(checkbox);

    posCell.innerHTML = `
        <button class="arrow-btn" onclick="moveUp(this)">⬆</button>
        <button class="arrow-btn" onclick="moveDown(this)">⬇</button>
    `;
}


// Move Up
function moveUp(btn){
    const row = btn.closest("tr");
    const prev = row.previousElementSibling;
    if(prev){
        row.parentNode.insertBefore(row, prev);
        updateSerial();
    }
}


// Move Down
function moveDown(btn){
    const row = btn.closest("tr");
    const next = row.nextElementSibling;
    if(next){
        row.parentNode.insertBefore(next, row);
        updateSerial();
    }
}


// Update Serial Numbers
function updateSerial(){
    const rows =
        document.querySelectorAll("#approverTable tbody tr");
    rows.forEach((row, index) => {
        row.cells[0].innerText = index + 1;
    });
}


// Back Button
function goBack(){
    window.location.href = "account_creation.html";
}

</script>

</body>
</html>




